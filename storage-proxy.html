<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>R-UI Storage Proxy</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<body>
<script>
/*
  R-UI Storage Proxy
  - Hard-coded token required for requests (simple auth)
  - Supports: get, set, remove, clear, keys
  - Replies with { ok: true/false, id, value, keys, error }
*/

(function(){
  // === CONFIG: set your secret token here ===
  const SECRET_TOKEN = 'RUI_9xPq2Lz7Vb1Hk4G'; // <- keep this secret

  function safePostMessage(targetWindow, origin, msg){
    try { targetWindow.postMessage(msg, origin); }
    catch (e) { /* ignore */ }
  }

  window.addEventListener('message', function(ev){
    const src = ev.source;
    const origin = ev.origin || '*';
    const req = ev.data;
    if (!req || typeof req !== 'object') return;

    // Security: token must match
    if (req.token !== SECRET_TOKEN) {
      safePostMessage(src, origin, { ok: false, error: 'invalid token', id: req.id || null });
      return;
    }

    const id = req.id || null;
    try {
      if (req.type === 'get') {
        const v = localStorage.getItem(req.key);
        safePostMessage(src, origin, { ok: true, id, value: v });
      } else if (req.type === 'set') {
        localStorage.setItem(req.key, String(req.value));
        safePostMessage(src, origin, { ok: true, id });
      } else if (req.type === 'remove') {
        localStorage.removeItem(req.key);
        safePostMessage(src, origin, { ok: true, id });
      } else if (req.type === 'clear') {
        localStorage.clear();
        safePostMessage(src, origin, { ok: true, id });
      } else if (req.type === 'keys') {
        safePostMessage(src, origin, { ok: true, id, keys: Object.keys(localStorage) });
      } else {
        safePostMessage(src, origin, { ok: false, id, error: 'unknown type' });
      }
    } catch (err) {
      safePostMessage(src, origin, { ok: false, id, error: String(err) });
    }
  }, false);

  // Optional: simple debug UI if you open directly with ?debug=1
  if (location.search.indexOf('debug=1') !== -1) {
    document.body.style.fontFamily = 'sans-serif';
    document.body.innerHTML = '<div style="padding:16px"><h3>R-UI Storage Proxy</h3><p>Token: ' + SECRET_TOKEN + '</p><p>Ready to accept postMessage requests from callers that include the token.</p></div>';
  }
})();
</script>
</body>
</html>